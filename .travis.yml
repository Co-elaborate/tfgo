language: go
os: linux
dist: focal
env:
    global:
        - TF_VERSION_MAJOR=2
        - TF_VERSION_MINOR=1
        - TF_VERSION_PATCH=2

# NOTE: as of today (1 nov 2020) we can use only version 2.1
# because TensorFlow >2.1 has a completely broken Go package that can't be build

before_install:
  # Install TensorFlow
  - sudo pip3 install tensorflow=="$TF_VERSION_MAJOR"."$TF_VERSION_MINOR"."$TF_VERSION_PATCH"
  - sudo pip3 install protobuf
  - sudo pip3 install -r test_models/requirements.txt
  # Install TensorFlow system library
  - curl -L "https://storage.googleapis.com/tensorflow/libtensorflow/libtensorflow-cpu-linux-x86_64-""$TF_VERSION_MAJOR"."$TF_VERSION_MINOR"."$TF_VERSION_PATCH"".tar.gz" | sudo tar -C /usr/local -xz
  - sudo ldconfig
  # Get and install TensorFlow Go bindings
  - git clone https://github.com/tensorflow/tensorflow $GOPATH/src/github.com/tensorflow/tensorflow/
  - pushd $GOPATH/src/github.com/tensorflow/tensorflow/tensorflow/go
  - git checkout r"$TF_VERSION_MAJOR"."$TF_VERSION_MINOR"
  - go build
  - popd
  # Install Goveralls
  - go get github.com/mattn/goveralls
  # Build models - used in tests
  - pushd test_models
  - sudo python3 create.py
  - sudo python3 estimator.py
  - popd
script:
  - $GOPATH/bin/goveralls -service=travis-ci
